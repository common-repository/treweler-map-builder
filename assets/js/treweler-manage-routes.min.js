!function(){"use strict";const{__:e}=wp.i18n;var t,o,r,a,l,n,i,s,c="",d="no",p=[];function u(e,t){return function(){let e,t=arguments,o=t.length,r=0;if(0===o)return!1;for(;r!==o;){if(t[r]===e||null===t[r])return!1;r++}return!0}(e)&&""!==e?e:t}jQuery.noConflict(),(s=jQuery)((function(){const y=document.getElementById("js-twer-route-map"),m=document.getElementById("js-twer-gpx-upload"),g=document.getElementById("js-twer-gpx-upload-panel"),f=document.getElementById("routeGPXFile"),h=document.getElementById("routeGPXFileName"),v=document.getElementById("js-twer-body");function _(e){void 0!==t.getSource("route")&&(s(".post-type-route .info-box #directions").html(""),t.removeLayer("route"),t.removeSource("route"),s("#routeCoords").val(""));var r=s("input[name='_treweler_route_profile']:checked").val();if(s(".post-type-route .info-box #directions").html(""),""===s("#routeGPXFile").val().trim()){if(Object.keys(p).length>0&&p.features.length>0&&void 0===e){if(o.set(p),(i=o.getAll()).features.length>0){var a=0,l=(c=i.features[a].geometry.coordinates).join(";"),n=[];c.forEach((e=>{n.push(25)})),"no"!=r?j(l,n,r):(b(i.features[a].geometry),w())}}else{var i=o.getAll();p=i,i.features.length>0&&(a=i.features.length-1,l=(c=i.features[a].geometry.coordinates).join(";"),n=[],c.forEach((e=>{n.push(25)})),"no"!=r?j(l,n,r):(b(i.features[a].geometry),w()))}if(i.features.length>0){var c=i.features[0].geometry.coordinates.join(";");s("#routeCoords").val(c)}}else B(s("#routeGPXFile").val())}function w(){try{t.getLayer("route")&&t.moveLayer("route")}catch(e){console.log(e)}}function j(e,t,o){t.join(";");var r="https://api.mapbox.com/directions/v5/mapbox/"+o+"/"+e+"?geometries=geojson&steps=true&overview=full&access_token="+mapboxgl.accessToken;jQuery.ajax({method:"GET",url:r}).done((function(e){e.routes.length>0?b(e.routes[0].geometry):s(".post-type-route .info-box #directions").html('<span id="direction-error">'+e.message+"</span>")})).fail((function(e,t){s(".post-type-route .info-box #directions").html('<span id="direction-error">'+e.responseJSON.message+"</span>")}))}function b(e){t.getSource("route")&&(s(".post-type-route .info-box #directions").html(""),t.removeLayer("route"),t.removeSource("route"));let o=s("#routeColor").val(),r=parseFloat(u(s("#route_line_opacity").val(),1)),a=parseFloat(u(s("#route_line_width").val(),3)),l=parseInt(u(s("#route_line_dash").val(),1)),n=parseInt(u(s("#route_line_gap").val(),0));r=r>=0&&r<=1?r:0,t.addLayer({id:"route",type:"line",source:{type:"geojson",data:{type:"Feature",properties:{},geometry:e}},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":o,"line-width":a,"line-opacity":r,"line-dasharray":[l,n]}});try{"undefined"===t.getLayer("route")&&t.addLayer({id:"gl-draw-line",type:"line",source:{type:"geojson",data:{type:"Feature",properties:{},geometry:e}},filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#317dfc","line-dasharray":[0,2],"line-width":2,"line-opacity":1}})}catch(e){console.log(e)}}function x(){s("input[name='_treweler_route_profile']:checked").val(),setTimeout((function(){jQuery("#js-twer-directions input[name='_treweler_route_profile']").trigger("change")}),500)}function k(){let e=o.getAll();if(e.features.length>0){var t=e.features[0].geometry.coordinates,r=t.join(";"),a=[];t.forEach((e=>{a.push(25)}));let o=s("input[name='_treweler_route_profile']:checked").val();"no"!==o?j(r,a,o):b(e.features[0].geometry)}}function E(){t.removeControl(o),o=new MapboxDraw({displayControlsDefault:!1,controls:{line_string:!0,trash:!0},styles:[r,a,l,n,i]}),t.addControl(o)}document.getElementById("latlng"),document.getElementById("setZoom"),document.getElementById("map_id"),localStorage.setItem("gpxUploadHadRun","yes"),window.TWER_ROUTE={map_style:"",draw:"",initMap:function(){jQuery(".twer-root").each((function(){jQuery(this).find('[data-toggle="tooltip"]').tooltip({container:s(this).closest(".twer-root")})})),c=twer_ajax.api_key,jQuery("#js-twer-route-map").html("");let e=jQuery("#latlng").val();e=e.substring(1,e.length-1).split(",");let d=e[1],u=e[0],y=""!=jQuery("#setZoom").val().trim()?parseFloat(jQuery("#setZoom").val()).toFixed(2):0,m=s("#map_id option:selected").toArray().map((e=>e.dataset.map_style)),g=s("#map_id option:selected").toArray().map((e=>e.dataset.mapProjection)),f=s("#map_id option:selected").toArray().map((e=>e.dataset.mapLightPreset));m.length<=0&&(m=["mapbox://styles/mapbox/standard-beta"]),g.length<=0&&(g=["mercator"]),mapboxgl.accessToken=c,o=new MapboxDraw({displayControlsDefault:!1,controls:{line_string:!0,trash:!0},styles:[r,a,l,n,i]}),(t=new mapboxgl.Map({container:"js-twer-route-map",style:m[0],center:[u,d],zoom:y,projection:{name:g[0]}})).on("style.load",(()=>{if("mapbox://styles/mapbox/standard-beta"===m[0]){let e=f[0]?f[0]:"day";t.setConfigProperty("basemap","lightPreset",e)}})),t.on("zoom",(function(){jQuery("#setZoom").val(parseFloat(t.getZoom()).toFixed(2));let e=t.getCenter();jQuery("#latlng").val("{"+e.lng+","+e.lat+"}")})),t.on("drag",(function(){let e=t.getCenter();jQuery("#latlng").val("{"+e.lng+","+e.lat+"}")})),t.addControl(o,"top-right"),t.on("draw.create",_),t.on("draw.update",_),t.on("draw.delete",A),t.on("load",(function(){if(""!=jQuery("#routeCoords").val().trim()&&""==jQuery("#routeGPXFile").val().trim()){let l=jQuery("#routeCoords").val(),n=[];l=l.split(";"),l.forEach((function(e){let t=[];e.split(",").forEach((function(e){t.push(parseFloat(e))})),n.push(t)})),p={type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{coordinates:n,type:"LineString"}}]};var e=jQuery("input[name='_treweler_route_profile']:checked").val();o.set(p);let i=o.getAll();if(i.features.length>0){var t=i.features[0].geometry.coordinates,r=t.join(";"),a=[];t.forEach((e=>{a.push(25)})),"no"!=e?j(r,a,e):b(i.features[0].geometry)}}else if(""!=jQuery("#routeGPXFile").val().trim()){let e=jQuery("#routeGPXFile").val();jQuery("input[name='_treweler_route_profile']").each((function(e,t){0!=e?jQuery(this).attr("disabled","disabled"):jQuery(this).attr("checked","checked")})),B(e)}}))}};const C=document.getElementById("js-twer-attach__add-file"),P=document.getElementById("js-twer-attach-container"),S=document.getElementById("js-twer-attach-actions"),I=document.getElementById("js-twer-attach-remove"),L=document.getElementById("js-twer-attach-change"),Q=document.getElementById("gpxErrorMessage");function F(){h.value.length&&f.value.length&&(g.removeChild(g.getElementsByTagName("p")[0]),h.value=f.value="",m.innerText=e("Upload file here","treweler"),m.setAttribute("href","#add"),C.style.display="block",P.style.display="block",S.style.display="none",localStorage.setItem("gpxUploadHadRun","no"))}function A(e){t.getSource("route")&&(s(".post-type-route .info-box #directions").html(""),F(),t.removeLayer("route"),t.removeSource("route"),s("#routeCoords").val(""),s("input[name='_treweler_route_profile']").each((function(e,t){0!=e&&s(this).removeAttr("disabled")})),p={type:"FeatureCollection",features:[]},o.set(p),localStorage.setItem("gpxUploadHadRun","no"))}function B(e){jQuery.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var a=[];if(s(e).find("trkpt").each((function(){a.push([parseFloat(s(this).attr("lon")),parseFloat(s(this).attr("lat"))])})),a.length){let e=s("#routeColor").val(),l=parseFloat(u(s("#route_line_opacity").val(),1)),n=parseFloat(u(s("#route_line_width").val(),3)),i=parseInt(u(s("#route_line_dash").val(),1)),c=parseInt(u(s("#route_line_gap").val(),0));if(l=l>=0&&l<=1?l:0,r={id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":e,"line-dasharray":[i,c],"line-width":n,"line-opacity":l}},E(),p={type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{coordinates:a,type:"LineString"}}]},o.set(p),b(o.getAll().features[0].geometry),"yes"!==localStorage.getItem("gpxUploadHadRun")){let e=a.reduce((function(e,t){return e.extend(t)}),new mapboxgl.LngLatBounds(a[0],a[0]));t.fitBounds(e,{padding:20})}localStorage.setItem("gpxUploadHadRun","yes"),Q&&(Q.style.display="none")}else Q&&(Q.style.display="block"),F()}})}L&&(L.addEventListener("click",(function(){let t;A(),t||(t=wp.media({title:e("Select GPX route","treweler"),button:{text:e("Upload GPX route","treweler")},library:{type:"application/gpx+xml"},multiple:!1}),t.on("select",(function(){const e=t.state().get("selection").first(),o=e.toJSON().url,r=e.attributes.filename;f.value=o,h.value=r,S.style.display="block",localStorage.setItem("gpxUploadHadRun","no"),G(),U(),B(o)}))),t.open()})),I.addEventListener("click",A)),"no"===s("input[name='_treweler_route_profile']:checked").val()?(s("#routeColor").val(),r={id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#317dfc","line-dasharray":[1,0],"line-width":3,"line-opacity":1}}):(d=s("input[name='_treweler_route_profile']:checked").val(),r={id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#317dfc","line-dasharray":[0,2],"line-width":2,"line-opacity":1}}),a={id:"gl-draw-polygon-and-line-vertex-halo-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":10,"circle-color":"#fff"}},n={id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#317dfc"}},l={id:"gl-draw-polygon-and-line-midpoint-halo-active",type:"circle",filter:["all",["==","meta","midpoint"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":0,"circle-color":"#fff"}},i={id:"gl-draw-polygon-and-line-midpoint-active",type:"circle",filter:["all",["==","meta","midpoint"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#317dfc"}};let T="",R="";function G(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[1,0,0,0];const t=document.getElementById("js-twer-directions"),o=t.getElementsByTagName("input");let r=0;for(let t of o)e[r]?(t.checked=!0,t.disabled=!1):(t.checked=!1,t.disabled=!0),r++}function U(){if(h&&h.value){let t=document.getElementsByClassName("gpx-trew-file");void 0!==t[0]&&t[0].remove();const o=document.createElement("p");o.className="hide-if-no-js gpx-trew-file";const r=document.createTextNode(h.value);o.appendChild(r),g.prepend(o),m.innerText=e("Remove this file","treweler"),m.setAttribute("href","#remove"),C.style.display="none",P.style.display="none",S.style.display="block"}else C.style.display="block",P.style.display="block"}if(s(".js-twer-select-2").on("select2:select.bsnselect",(function(e){var o=e.params.data.element,r=s(o);r.detach(),s(this).append(r),s(this).trigger("change");let a=s("#map_id option:selected").toArray().map((e=>e.dataset.map_style)),l=s("#map_id option:selected").toArray().map((e=>e.dataset.mapProjection)),n=s("#map_id option:selected").toArray().map((e=>e.dataset.mapLightPreset));a.length<=0&&(a=["mapbox://styles/mapbox/standard-beta"]),l.length<=0&&(l=["mercator"]),T=a[0],t.setStyle(a[0]),R=l[0],t.setProjection(l[0]),"mapbox://styles/mapbox/standard-beta"===a[0]&&t.on("style.load",(()=>{let e=n[0]?n[0]:"day";t.setConfigProperty("basemap","lightPreset",e)})),k(),x()})),s(".js-twer-select-2").on("change",(function(){let e=s("#map_id option:selected").toArray().map((e=>e.dataset.map_style)),o=s("#map_id option:selected").toArray().map((e=>e.dataset.mapProjection)),r=s("#map_id option:selected").toArray().map((e=>e.dataset.mapLightPreset));e.length<=0&&(e=["mapbox://styles/mapbox/standard-beta"],t.setStyle(e[0])),e.length>0&&!e.includes(T)&&(T=e[0],t.setStyle(T)),o.length<=0&&(o=["mercator"],t.setProjection(o[0])),o.length>0&&!o.includes(R)&&(R=o[0],t.setProjection(R)),"mapbox://styles/mapbox/standard-beta"===e[0]&&t.on("style.load",(()=>{let e=r[0]?r[0]:"day";t.setConfigProperty("basemap","lightPreset",e)})),k(),x()})),jQuery("#js-twer-directions input[name='_treweler_route_profile']").on("change",(function(){0!==Object.keys(p).length&&0!==p.features.length||(p=o.getAll());let e=!0;"no"!==s(this).val()&&"no"===d?(d=s(this).val(),r={id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#317dfc","line-dasharray":[0,2],"line-width":2,"line-opacity":1}},E(),_(),e=!1):"no"===s(this).val()&&"no"!==d&&(d=s(this).val(),s("#routeColor").val(),r={id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#317dfc","line-dasharray":[1,0],"line-width":3,"line-opacity":1}},E(),_(),e=!0),e&&_(),w()})),s("#color-picker-btn, .clr-picker span").on("click",(function(){0===s(".color-picker").find(".a-color-picker").length?TWER_HELPERS.AColorPicker.from(".color-picker").on("change",((e,t)=>{s(".clr-picker span").css("background-color",e.color),s("#routeColor").val(e.color),s(".color-picker").attr("acp-color",e.color),"mousedown"!==event.type&&"click"!==event.type||_()})).on("coloradd",((e,t)=>{let o=s("#addCustomColor");-1===o.val().indexOf("|"+t)&&(o.val(o.val()+"|"+t),jQuery.ajax({url:twer_ajax.url,type:"POST",data:{action:"treweler_add_colorpicker_custom_color",cust_color:o.val()},success:function(e){let t=s(".color-picker"),o=t.attr("default-palette");t.attr("acp-palette",o+""+e)}}))})).on("colorremove",((e,t)=>{let o=s("#addCustomColor");if(-1!==o.val().indexOf("|"+t)){let e=o.val().replace("|"+t,"");o.val(e),jQuery.ajax({url:twer_ajax.url,type:"POST",data:{action:"treweler_add_colorpicker_custom_color",cust_color:o.val()},success:function(e){let t=s(".color-picker"),o=t.attr("default-palette");t.attr("acp-palette",o+""+e)}})}})):s(".color-picker").find(".a-color-picker").remove()})),s(window).on("click",(function(e){s(e.target).hasClass("a-color-picker")||0!=s(e.target).parents(".a-color-picker").length||"color-picker-btn"==s(e.target).attr("id")||s(e.target).hasClass("color-holder")||s(e.target).hasClass("a-color-picker-palette-color")||s(".color-picker").find(".a-color-picker").remove()})),s("#route_line_width, #route_line_opacity, #route_line_dash,#route_line_gap").on("input",(function(){_()})),g&&U(),m){let t;m.addEventListener("click",(o=>{if(o.preventDefault(),"#add"===o.target.getAttribute("href")){if(t)return void t.open();t=wp.media({title:e("Select GPX route","treweler"),button:{text:e("Upload GPX route","treweler")},library:{type:"application/gpx+xml"},multiple:!1}),t.on("select",(function(){const e=t.state().get("selection").first(),o=e.toJSON().url,r=e.attributes.filename;localStorage.setItem("gpxUploadHadRun","no"),f.value=o,h.value=r,S.style.display="block",G(),U(),B(o)})),t.open()}else localStorage.setItem("gpxUploadHadRun","no"),A()}))}y&&twer_ajax.api_key_is_valid?TWER_ROUTE.initMap():v.insertAdjacentHTML("afterbegin",`<div id="setting-error-treweler_invalid_api" class="notice notice-error settings-error is-dismissible"> \n<p><strong>${e("Mapbox access token is invalid. Please, enter a valid Mapbox access token.","treweler")}</strong></p><button type="button" class="notice-dismiss"><span class="screen-reader-text">${e("Dismiss this notice.","treweler")}</span></button></div>`),s(".twer-root").tooltip({selector:".twer-help-tooltip"})}))}();