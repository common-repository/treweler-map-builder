!function(){"use strict";function e(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class t{constructor(t){e(this,"regions",""),e(this,"regionsSelected",[]),e(this,"fillMain",""),e(this,"fillHover",""),e(this,"fillSelected",""),e(this,"strokeColor",""),e(this,"strokeWidth",""),e(this,"regionsCustomColors",""),e(this,"regionsHide",""),e(this,"worldsSlugs",["world","united-states","united-kingdom","spain","italy","germany","france","canada","australia"]),e(this,"accuracyList",["very_high","high","medium","low","very_low"]),e(this,"worldsGeoJson",{}),e(this,"worldsList",{}),e(this,"$popup",null),e(this,"preloader",null),this.regions=TWER.data.boundariesRegions,this.regionsSelected=TWER.data.boundariesRegionsSelected,this.fillMain=TWER.data.boundariesFillMain,this.fillHover=TWER.data.boundariesFillHover,this.fillSelected=TWER.data.boundariesFillSelected,this.strokeColor=TWER.data.boundariesStrokeColor,this.strokeWidth=TWER.data.boundariesStrokeWidth,this.boundariesAccuracy=TWER.data.boundariesAccuracy,this.regionsCustomColors=TWER.data.boundariesRegionsCustomColors,this.regionsHide=TWER.data.boundariesRegionsHide,this.regionsClickable=TWER.data.actionOnClickBoundaries,this.regionsLinks=TWER.data.boundariesLinks,this.regionsHoverables=TWER.data.actionOnHoverBoundaries,this.regionsValues=TWER.data.boundariesValues,this.regionsValuesPrefix=TWER.data.boundariesValuesPrefix,this.preloader=new class{constructor(){e(this,"$preloader",null),e(this,"$counter",null),this.$preloader=document.getElementsByClassName("twer-preloader"),this.$counter=document.querySelectorAll(".twer-preloader .loading-progress"),TWER.data.boundaries||this.initPreloader(),TWER.map.on("idle",(e=>{TWER.data.boundaries||this.hide()}))}initPreloader(){if(this.$preloader.length>0){let e=0;if(0===e){e=1;let t=1;const i=setInterval((()=>{let s=Math.floor(5*Math.random()+95);t>=s?(clearInterval(i),e=0):(t++,this.$counter.length>0&&(this.$counter[0].innerHTML=`${t}%`))}),10)}}}hide(){this.$preloader.length>0&&setTimeout((()=>{this.$preloader[0].classList.add("twer-preloader--hide")}),500)}},this.preloader.initPreloader(),this.worldListFill(),"none"!==this.regionsHoverables&&this.initPopup();let i=null;TWER.map.on("load",(async()=>{this.getFileNameFromRegion(),this.fetchData().then((e=>{this.worldsGeoJson=this.prepareGeoJson(e);const t={id:"boundaries-layer",type:"fill",source:"boundaries",paint:{"fill-color":this.generateFeatureStateFilter(),"fill-outline-color":"rgba(255, 255, 255, 0)"}},s={id:"boundaries-line-layer",type:"line",source:"boundaries",paint:{"line-width":this.strokeWidth,"line-color":this.strokeColor}},o=["all"];if("world"!==this.regions){const e=this.prepare_regions();o.push(["==",["get",e.column],e.value]),""!==e.admin&&o.push(["==",["get",e.admin],e.admin_num])}else o.push(["!=",["get","COUNTRY"],"France"]),o.push(["!=",["get","COUNTRY"],"United States"]),o.push(["!=",["get","COUNTRY"],"United Kingdom"]),o.push(["!=",["get","COUNTRY"],"Spain"]),o.push(["!=",["get","COUNTRY"],"Italy"]),o.push(["!=",["get","COUNTRY"],"Germany"]),o.push(["!=",["get","COUNTRY"],"Canada"]),o.push(["!=",["get","COUNTRY"],"Australia"]);if(""!==this.regionsHide&&this.regionsHide.length>0){const e=JSON.parse(this.regionsHide);for(let t=0;t<e.length;t++)o.push(["!=",["id"],parseInt(e[t])])}t.filter=o,s.filter=o,TWER.map.addSource("boundaries",{type:"geojson",data:this.worldsGeoJson[this.boundariesAccuracy]}),TWER.map.addLayer(t),TWER.map.addLayer(s),this.selectRegions(),TWER.map.on("mouseenter","boundaries-layer",(()=>{TWER.map.getCanvas().style.cursor="pointer"})),TWER.map.on("mousemove","boundaries-layer",(e=>{e.features.length>0&&this.isClosestHoverable(e)&&(null!==i&&this.fillRegionColor(i,{action:"unhover"}),i=e.features[0].id,this.fillRegionColor(i,{action:"hover"}),this.selectRegions(i),this.popup(e))})),TWER.map.on("mouseleave","boundaries-layer",(e=>{null!==i&&TWER.map.setFeatureState({source:"boundaries",id:i},{action:"unhover"}),i=null,this.selectRegions(i),this.popup(),TWER.map.getCanvas().style.cursor=""})),TWER.map.on("click","boundaries-layer",(e=>{if(e.features.length>0){const t=e.features[0].id;if("none"!==this.regionsClickable&&this.regionsLinks.length>0){const e=JSON.parse(this.regionsLinks);for(let i=0;i<e.length;i++)e[i].id===t&&(document.body.classList.contains("twer-page-iframe-map")?window.open(e[i].url,"_blank"):e[i].target?window.open(e[i].url,e[i].target):window.location.href=e[i].url)}}})),TWER.map.once("idle",(e=>{this.preloader.hide()}));const r=TWER.map.getStyle().layers;if(r.length>0)for(let e=0;e<r.length;e++){const t=r[e].id;(t.includes("route-")||"line_layer"===t||"polygon_layer_fill"===t||"polygon_layer_stroke"===t)&&TWER.map.moveLayer(t)}})).catch((e=>{console.log(e)}))}))}prepareGeoJson(e){for(let t in e)if(e[t].features.length>0){let i=1;for(let s=0;s<e[t].features.length;s++)e[t].features[s].id=i,i++}return e}worldListFill(){for(let e=0;e<this.accuracyList.length;e++){const t=this.accuracyList[e],i=t.replace(/_/g,"-");this.worldsList[t]={urls:[]};for(let e=0;e<this.worldsSlugs.length;e++){const s=this.worldsSlugs[e];"world"===s?this.worldsList[t].urls.push(`${s}-${i}.json`):this.worldsList[t].urls.push(`${s}-${i}-01.json`,`${s}-${i}-02.json`)}}}async fetchData(){const e={};for(let t=0;t<this.accuracyList.length;t++){const i=this.accuracyList[t];let s=await Promise.all(this.worldsList[i].urls.map((e=>fetch(`${treweler_params.data}${e}`).then((e=>e.json())))));if(e[i]={type:"",features:[]},s.length>0)for(let t=0;t<s.length;t++)e[i].type=s[t].type,e[i].features.push(...s[t].features)}return e}initPopup(){this.$popup=document.createElement("div"),this.$popup.classList.add("twer-region-popup");const e=document.createElement("div");e.id="js-twer-popup-title";const t=document.createElement("div");t.id="js-twer-popup-value",t.classList.add("twer-region-popup__value"),this.$popup.appendChild(e),this.$popup.appendChild(t),document.body.appendChild(this.$popup)}isClosestHoverable(e){var t;let i=!0;const s=null==e||null===(t=e.originalEvent)||void 0===t?void 0:t.target;return s&&(s.closest(".treweler-marker-cluster")||s.closest(".js-twer-marker")||s.closest(".treweler-marker"))&&(i=!1),i}popup(e){if("none"!==this.regionsHoverables){let t=""===this.regionsValues.trim()?[]:JSON.parse(this.regionsValues);const i=TWER.map.getCanvas();if(e&&void 0!==e&&this.isClosestHoverable(e)){const s=e.features[0].id,o=e.features[0].properties.NAME;let r="",l="";if("popup_value"===this.regionsHoverables&&(l=`${this.regionsValuesPrefix} `),t.length>0)for(let e=0;e<t.length;e++)t[e].id===s&&(r=t[e].value);i.style.cursor="pointer",this.$popup.querySelector("#js-twer-popup-title").textContent=o,r&&"popup_value"===this.regionsHoverables?this.$popup.querySelector("#js-twer-popup-value").textContent=l+r:this.$popup.querySelector("#js-twer-popup-value").textContent="";const n=this.$popup.getBoundingClientRect(),a=n.height,u=n.width,h=document.getElementById("wpadminbar");let p=0;null!==h&&(p=h.getBoundingClientRect().height),this.$popup.style.left=e.originalEvent.clientX-u/2+"px",this.$popup.style.top=e.originalEvent.clientY-(a+8+p)+"px",this.$popup.style.visibility="visible",this.$popup.style.opacity=1}else i.style.cursor="",this.$popup.style.visibility="hidden",this.$popup.style.opacity=0,this.$popup.querySelector("#js-twer-popup-title").textContent="",this.$popup.querySelector("#js-twer-popup-value").textContent=""}}selectRegions(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=""===this.regionsSelected.trim()?[]:JSON.parse(this.regionsSelected);if(t.length>0&&Array.isArray(t))for(let i=0;i<t.length;i++)if(t[i]!==e){const e=t[i],s=this.checkIdHasCustomColor(e);s.hasColor&&s.active?this.fillRegionColor(e,{action:"customize"}):this.fillRegionColor(e,{action:"select"})}}checkIdHasCustomColor(e){let t=""===this.regionsCustomColors.trim()?[]:JSON.parse(this.regionsCustomColors),i=!1,s=0,o=!1;if(t.length>0)for(let r=0;r<t.length;r++)if(e===t[r].id){i=!0,s=r,o=t[r].active;break}return{hasColor:i,index:s,active:o}}generateFeatureStateFilter(){let e=""===this.regionsCustomColors.trim()?[]:JSON.parse(this.regionsCustomColors);const t=["match",["feature-state","action"],"hover",this.fillHover,"select",this.fillSelected,"unselect",this.fillHover,"unhover",this.fillMain,this.fillMain];if(e.length>0){let i=0;for(let s=0;s<e.length;s++)if(e[s].active){let o=2+i,r=3+i;t.splice(o,0,`customize_${e[s].id}`),t.splice(r,0,e[s].color),i+=2}}return t}fillRegionColor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i="action"in t&&t.action;if(i){let t=i;"customize"===i&&(t=`customize_${e}`),TWER.map.setFeatureState({source:"boundaries",id:e},{action:t})}}getFileNameFromRegion(){const e=this.boundariesAccuracy.replace(/_/g,"-");let t=`world-${e}.json`;if("world"!==this.regions){const{COUNTRY:i,ADMIN:s}=JSON.parse(this.regions);i&&s&&(t=`${i.toLowerCase()}-${e}-0${s}.json`)}return t}prepare_regions(){const e="world"===this.regions?{}:JSON.parse(this.regions);let t="",i="",s="",o=-1;if(0===Object.keys(e).length)t="world";else for(let r in e)"ADMIN"===r?(s=r,o=e[r]):(t=r,i=e[r]);return{column:t,value:i,admin:s,admin_num:parseInt(o)}}}window.addEventListener("load",(()=>{new t}))}();